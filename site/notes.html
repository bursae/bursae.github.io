<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Place Notes | Anthony Bursae</title>
  <meta id="meta-description" name="description" content="Place notes by Anthony Bursae on geography, history, and travel." />
  <meta name="robots" content="index,follow" />
  <link id="meta-canonical" rel="canonical" href="https://anthonybursae.com/site/notes.html" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Anthony Bursae" />
  <meta property="og:type" content="website" />
  <meta id="meta-og-url" property="og:url" content="https://anthonybursae.com/site/notes.html" />
  <meta id="meta-og-title" property="og:title" content="Place Notes | Anthony Bursae" />
  <meta id="meta-og-description" property="og:description" content="Place notes by Anthony Bursae on geography, history, and travel." />
  <meta id="meta-og-image" property="og:image" content="https://anthonybursae.com/images/lyndhurst.png" />
  <meta property="og:image:alt" content="Lyndhurst note image" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta id="meta-twitter-title" name="twitter:title" content="Place Notes | Anthony Bursae" />
  <meta id="meta-twitter-description" name="twitter:description" content="Place notes by Anthony Bursae on geography, history, and travel." />
  <meta id="meta-twitter-image" name="twitter:image" content="https://anthonybursae.com/images/lyndhurst.png" />
  <link rel="icon" href="../images/favicon.svg" type="image/svg+xml" />
  <link rel="icon" href="../images/favicon-32x32.png" type="image/png" sizes="32x32" />
  <link rel="icon" href="../images/favicon-16x16.png" type="image/png" sizes="16x16" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
<div class="site-container">
  <div class="page">

    <header class="site-header">
      <a href="../index.html"><img src="../images/dancer.png" alt="Anthony Bursae logo" width="1024" height="1024" /></a>
      <h1><a href="../index.html">Anthony Bursae</a></h1>
      <nav>
        <a href="about.html">About</a>
        <a href="projects.html">Portfolio</a>
        <a href="notes.html" class="active" aria-current="page">Gallery</a>
      </nav>
    </header>

    <main class="narrow-main">
      <p class="section-label">Place Notes</p>
      <div id="note-list" class="note-list">Loading notes...</div>

      <div id="note-content" class="is-hidden">
        <a href="notes.html" class="button secondary notes-back-button">← Back to Gallery</a>
        <div id="note-body"></div>
      </div>
    </main>

    <footer>
      <p>© 2026 Anthony Bursae • 
        <a href="https://www.linkedin.com/in/anthonybursae/">LinkedIn</a> •
        <a href="https://github.com/bursae">GitHub</a>
      </p>
    </footer>

  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const file = params.get('file');
  const siteOrigin = "https://anthonybursae.com";
  const defaultNotesTitle = "Place Notes | Anthony Bursae";
  const defaultNotesDescription = "Place notes by Anthony Bursae on geography, history, and travel.";
  const defaultNotesImage = `${siteOrigin}/images/lyndhurst.png`;
  const notesBaseUrl = `${siteOrigin}/site/notes.html`;
  const noteList = document.getElementById('note-list');
  const noteContent = document.getElementById('note-content');
  const noteBody = document.getElementById('note-body');

  function setMetaById(id, value) {
    const el = document.getElementById(id);
    if (el && value) {
      el.setAttribute('content', value);
    }
  }

  function updateNotesMetadata(note) {
    if (!note) {
      document.title = defaultNotesTitle;
      setMetaById("meta-description", defaultNotesDescription);
      setMetaById("meta-og-title", defaultNotesTitle);
      setMetaById("meta-og-description", defaultNotesDescription);
      setMetaById("meta-og-url", notesBaseUrl);
      setMetaById("meta-og-image", defaultNotesImage);
      setMetaById("meta-twitter-title", defaultNotesTitle);
      setMetaById("meta-twitter-description", defaultNotesDescription);
      setMetaById("meta-twitter-image", defaultNotesImage);
      const canonical = document.getElementById("meta-canonical");
      if (canonical) {
        canonical.setAttribute("href", notesBaseUrl);
      }
      return;
    }

    const noteTitle = `${note.title} | Place Notes | Anthony Bursae`;
    const noteDescription = note.description || `${note.title} place note by Anthony Bursae.`;
    const noteUrl = `${notesBaseUrl}?file=${encodeURIComponent(note.file)}`;
    const noteImage = note.thumbnail
      ? `${siteOrigin}/${note.thumbnail.replace(/^\.\.\//, "")}`
      : defaultNotesImage;

    document.title = noteTitle;
    setMetaById("meta-description", noteDescription);
    setMetaById("meta-og-title", noteTitle);
    setMetaById("meta-og-description", noteDescription);
    setMetaById("meta-og-url", noteUrl);
    setMetaById("meta-og-image", noteImage);
    setMetaById("meta-twitter-title", noteTitle);
    setMetaById("meta-twitter-description", noteDescription);
    setMetaById("meta-twitter-image", noteImage);

    const canonical = document.getElementById("meta-canonical");
    if (canonical) {
      canonical.setAttribute("href", noteUrl);
    }
  }

  function escapeHtml(text) {
    const span = document.createElement('span');
    span.textContent = text;
    return span.innerHTML;
  }

  function isSafeMarkdownFile(filename) {
    return /^[a-z0-9_-]+\.md$/i.test(filename);
  }

  function setError(message) {
    noteBody.innerHTML = `<p>${escapeHtml(message)}</p>`;
  }

  function renderNotesList(notes) {
    if (!Array.isArray(notes) || notes.length === 0) {
      noteList.textContent = "No notes published yet.";
      return;
    }

    noteList.innerHTML = "";
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
      const item = document.createElement("div");
      item.className = "note-list-item";

      const link = document.createElement("a");
      link.className = "gallery-card";
      link.href = `notes.html?file=${encodeURIComponent(note.file)}`;

      if (note.thumbnail) {
        const thumb = document.createElement("img");
        thumb.className = "gallery-thumb";
        thumb.src = note.thumbnail;
        thumb.alt = note.title;
        thumb.loading = "lazy";
        thumb.decoding = "async";
        link.appendChild(thumb);
      }

      const title = document.createElement("h3");
      title.textContent = note.title;
      link.appendChild(title);

      item.appendChild(link);
      fragment.appendChild(item);
    });

    noteList.appendChild(fragment);
  }

  async function fetchNotesIndex() {
    const res = await fetch('../posts/posts.json', { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to load posts index (${res.status})`);
    }
    return res.json();
  }

  async function fetchNoteFile(filename) {
    const res = await fetch(`../posts/${filename}`, { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to load note (${res.status})`);
    }
    return res.text();
  }

  function renderMarkdown(markdown) {
    marked.setOptions({ gfm: true, breaks: false });
    const unsafeHtml = marked.parse(markdown);
    const safeHtml = window.DOMPurify
      ? window.DOMPurify.sanitize(unsafeHtml)
      : unsafeHtml;
    noteBody.innerHTML = safeHtml;
  }

  async function initNotesPage() {
    try {
      const notes = await fetchNotesIndex();
      const noteMap = new Map(notes.map(note => [note.file, note]));

      if (file) {
        noteList.classList.add('is-hidden');
        noteContent.classList.remove('is-hidden');
        noteBody.textContent = "Loading note...";

        if (!isSafeMarkdownFile(file) || !noteMap.has(file)) {
          setError("That note could not be found.");
          return;
        }

        const note = noteMap.get(file);
        const markdown = await fetchNoteFile(file);
        renderMarkdown(markdown);
        updateNotesMetadata(note);
      } else {
        noteList.classList.remove('is-hidden');
        noteContent.classList.add('is-hidden');
        renderNotesList(notes);
        updateNotesMetadata(null);
      }
    } catch (err) {
      console.error(err);
      if (file) {
        noteList.classList.add('is-hidden');
        noteContent.classList.remove('is-hidden');
        setError("Failed to load this note.");
      } else {
        noteList.classList.remove('is-hidden');
        noteContent.classList.add('is-hidden');
        noteList.textContent = "Failed to load gallery.";
      }
    }
  }

  initNotesPage();
</script>
</body>
</html>
