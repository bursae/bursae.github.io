<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gallery – Anthony Bursae</title>
  <meta name="description" content="Photo notes by Anthony Bursae on places, history, and travel." />
  <link rel="icon" href="../images/favicon-16x16.png" type="image/png" />
  <link rel="stylesheet" href="../css/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
<div class="site-container">
  <div class="page">

    <header class="site-header">
      <a href="../index.html"><img src="../images/dancer.png" alt="Anthony Bursae logo" width="1024" height="1024" /></a>
      <h1><a href="../index.html">Anthony Bursae</a></h1>
      <nav>
        <a href="about.html">About</a>
        <a href="projects.html">Portfolio</a>
        <a href="notes.html" class="active" aria-current="page">Gallery</a>
      </nav>
    </header>

    <main class="narrow-main">
      <p class="section-label">Place Notes</p>
      <div id="note-list" class="note-list">Loading notes...</div>

      <div id="note-content" class="is-hidden">
        <a href="notes.html" class="button secondary notes-back-button">← Back to Gallery</a>
        <div id="note-body"></div>
      </div>
    </main>

    <footer>
      <p>© 2026 Anthony Bursae • 
        <a href="https://www.linkedin.com/in/anthonybursae/">LinkedIn</a> •
        <a href="https://github.com/bursae">GitHub</a>
      </p>
    </footer>

  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const file = params.get('file');
  const noteList = document.getElementById('note-list');
  const noteContent = document.getElementById('note-content');
  const noteBody = document.getElementById('note-body');

  function escapeHtml(text) {
    const span = document.createElement('span');
    span.textContent = text;
    return span.innerHTML;
  }

  function isSafeMarkdownFile(filename) {
    return /^[a-z0-9_-]+\.md$/i.test(filename);
  }

  function setError(message) {
    noteBody.innerHTML = `<p>${escapeHtml(message)}</p>`;
  }

  function renderNotesList(notes) {
    if (!Array.isArray(notes) || notes.length === 0) {
      noteList.textContent = "No notes published yet.";
      return;
    }

    noteList.innerHTML = "";
    const fragment = document.createDocumentFragment();
    notes.forEach(note => {
      const item = document.createElement("div");
      item.className = "note-list-item";

      const link = document.createElement("a");
      link.className = "gallery-card";
      link.href = `notes.html?file=${encodeURIComponent(note.file)}`;

      if (note.thumbnail) {
        const thumb = document.createElement("img");
        thumb.className = "gallery-thumb";
        thumb.src = note.thumbnail;
        thumb.alt = note.title;
        thumb.loading = "lazy";
        thumb.decoding = "async";
        link.appendChild(thumb);
      }

      const title = document.createElement("h3");
      title.textContent = note.title;
      link.appendChild(title);

      item.appendChild(link);
      fragment.appendChild(item);
    });

    noteList.appendChild(fragment);
  }

  async function fetchNotesIndex() {
    const res = await fetch('../posts/posts.json', { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to load posts index (${res.status})`);
    }
    return res.json();
  }

  async function fetchNoteFile(filename) {
    const res = await fetch(`../posts/${filename}`, { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to load note (${res.status})`);
    }
    return res.text();
  }

  function renderMarkdown(markdown) {
    marked.setOptions({ gfm: true, breaks: false });
    const unsafeHtml = marked.parse(markdown);
    const safeHtml = window.DOMPurify
      ? window.DOMPurify.sanitize(unsafeHtml)
      : unsafeHtml;
    noteBody.innerHTML = safeHtml;
  }

  async function initNotesPage() {
    try {
      const notes = await fetchNotesIndex();
      const noteMap = new Map(notes.map(note => [note.file, note]));

      if (file) {
        noteList.classList.add('is-hidden');
        noteContent.classList.remove('is-hidden');
        noteBody.textContent = "Loading note...";

        if (!isSafeMarkdownFile(file) || !noteMap.has(file)) {
          setError("That note could not be found.");
          return;
        }

        const note = noteMap.get(file);
        const markdown = await fetchNoteFile(file);
        renderMarkdown(markdown);
        document.title = `${note.title} – Gallery – Anthony Bursae`;
      } else {
        noteList.classList.remove('is-hidden');
        noteContent.classList.add('is-hidden');
        renderNotesList(notes);
      }
    } catch (err) {
      console.error(err);
      if (file) {
        noteList.classList.add('is-hidden');
        noteContent.classList.remove('is-hidden');
        setError("Failed to load this note.");
      } else {
        noteList.classList.remove('is-hidden');
        noteContent.classList.add('is-hidden');
        noteList.textContent = "Failed to load gallery.";
      }
    }
  }

  initNotesPage();
</script>
</body>
</html>
